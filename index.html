<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Serisuk Laundry Service</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* ==========================================
           Modern Thai Laundry Service Design
           Theme: Clean, Professional, Trust-worthy
           Colors: Fresh Blue + Clean White
        ========================================== */
        
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&family=Lexend:wght@300;400;500;600&display=swap');
        
        :root {
            --primary: #0891b2;
            --primary-dark: #0e7490;
            --primary-light: #06b6d4;
            --secondary: #f0f9ff;
            --accent: #0ea5e9;
            --text-dark: #0f172a;
            --text-light: #64748b;
            --success: #10b981;
            --error: #ef4444;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Prompt', 'Lexend', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            color: var(--text-dark);
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }
        
        /* Language Toggle */
        .lang-toggle {
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 1000;
            display: flex;
            gap: 4px;
            background: white;
            border-radius: 20px;
            padding: 4px;
            box-shadow: var(--shadow);
        }
        
        .lang-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--text-light);
            font-size: 14px;
            font-weight: 500;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Lexend', sans-serif;
        }
        
        .lang-btn.active {
            background: var(--primary);
            color: white;
        }
        
        /* Container */
        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 80px 20px 40px;
            animation: fadeIn 0.6s ease;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Header */
        .header {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .header-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-size: 40px;
            box-shadow: var(--shadow-lg);
            animation: bounce 1s ease infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 8px;
        }
        
        .header p {
            font-size: 16px;
            color: var(--text-light);
            font-weight: 400;
        }
        
        /* Card */
        .card {
            background: white;
            border-radius: 24px;
            padding: 32px 24px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 20px;
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 24px;
        }
        
        label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }
        
        input, select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            font-family: 'Prompt', sans-serif;
            transition: all 0.3s ease;
            background: white;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.1);
        }
        
        /* Package Selection */
        .package-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-top: 12px;
        }
        
        .package-item {
            position: relative;
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .package-item:hover {
            border-color: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .package-item.selected {
            border-color: var(--primary);
            background: var(--secondary);
        }
        
        .package-item input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .package-label {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .package-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .package-item.selected .package-checkbox {
            background: var(--primary);
            border-color: var(--primary);
        }
        
        .package-checkbox::after {
            content: '‚úì';
            color: white;
            font-size: 16px;
            font-weight: bold;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s ease;
        }
        
        .package-item.selected .package-checkbox::after {
            opacity: 1;
            transform: scale(1);
        }
        
        .package-name {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-dark);
            flex: 1;
        }
        
        .delete-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: #fee2e2;
            color: var(--error);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }
        
        .delete-btn:hover {
            background: var(--error);
            color: white;
        }
        
        /* Buttons */
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            font-family: 'Prompt', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            box-shadow: var(--shadow);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        
        .btn-secondary:hover {
            background: var(--secondary);
        }
        
        /* Location Button */
        .location-btn {
            background: white;
            border: 2px dashed var(--primary);
            color: var(--primary);
            margin-top: 12px;
        }
        
        .location-btn:hover {
            background: var(--secondary);
            border-style: solid;
        }
        
        .location-status {
            margin-top: 12px;
            padding: 12px;
            border-radius: 8px;
            background: var(--secondary);
            color: var(--primary-dark);
            font-size: 14px;
            text-align: center;
        }
        
        .location-status.success {
            background: #d1fae5;
            color: #065f46;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px 20px;
        }
        
        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Section Display */
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* Success Animation */
        .success-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 48px;
            animation: scaleIn 0.5s ease;
        }
        
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .success-text {
            text-align: center;
            font-size: 18px;
            color: var(--text-dark);
            margin-bottom: 24px;
        }
        
        /* Info Box */
        .info-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 16px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 14px;
            line-height: 1.6;
            color: #78350f;
        }
        
        /* Current Packages Display */
        .current-packages {
            margin-bottom: 24px;
        }
        
        .current-packages h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 12px;
        }
        
        .section-divider {
            height: 2px;
            background: linear-gradient(90deg, var(--primary) 0%, transparent 100%);
            margin: 24px 0;
        }
        
        /* Hidden class */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Language Toggle -->
    <div class="lang-toggle">
        <button class="lang-btn active" onclick="setLanguage('th')">‡πÑ‡∏ó‡∏¢</button>
        <button class="lang-btn" onclick="setLanguage('en')">EN</button>
    </div>

    <div class="container">
        <!-- Loading Section -->
        <div id="loadingSection" class="section active">
            <div class="loading">
                <div class="spinner"></div>
                <p id="loadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
            </div>
        </div>

        <!-- Registration Section -->
        <div id="registrationSection" class="section">
            <div class="header">
                <div class="header-icon">üß∫</div>
                <h1 id="regTitle">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h1>
                <p id="regSubtitle">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            </div>

            <div class="card">
                <div class="form-group">
                    <label id="labelRoomNumber">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á</label>
                    <input type="text" id="roomNumber" placeholder="‡πÄ‡∏ä‡πà‡∏ô 123, A-101">
                </div>

                <div class="form-group">
                    <label id="labelLocationName">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î/‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</label>
                    <input type="text" id="locationName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏î‡∏≠‡∏∞ ‡πÄ‡∏ö‡∏™ ‡πÅ‡∏à‡πâ‡∏á‡∏ß‡∏±‡∏í‡∏ô‡∏∞">
                </div>

                <div class="form-group">
                    <label id="labelLocationType">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                    <select id="locationType">
                        <option value="condo">‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î‡∏°‡∏¥‡πÄ‡∏ô‡∏µ‡∏¢‡∏°</option>
                        <option value="village">‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</option>
                        <option value="apartment">‡∏≠‡∏û‡∏≤‡∏£‡πå‡∏ï‡πÄ‡∏°‡∏ô‡∏ï‡πå</option>
                    </select>
                </div>

                <div class="form-group">
                    <label id="labelPickupPoint">‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö-‡∏™‡πà‡∏á‡∏ú‡πâ‡∏≤</label>
                    <input type="text" id="pickupPoint" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏´‡πâ‡∏≠‡∏á, ‡∏•‡πá‡∏≠‡∏ö‡∏ö‡∏µ‡πâ">
                </div>

                <div class="form-group">
                    <label id="labelSelectPackages">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Package ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡πà‡∏≠‡∏¢ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</label>
                    <div class="package-grid" id="packageGrid"></div>
                </div>

                <button class="btn btn-primary" onclick="registerCustomer()" id="btnRegister">
                    <span>üìù</span> <span id="btnRegisterText">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</span>
                </button>
            </div>
        </div>

        <!-- Manage Packages Section -->
        <div id="managePackagesSection" class="section">
            <div class="header">
                <div class="header-icon">üì¶</div>
                <h1 id="manageTitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Package</h1>
                <p id="manageSubtitle">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Package ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ</p>
            </div>

            <div class="card">
                <div class="current-packages" id="currentPackagesDiv">
                    <h3 id="labelCurrentPackages">Package ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</h3>
                    <div class="package-grid" id="currentPackagesGrid"></div>
                </div>

                <div class="section-divider"></div>

                <h3 id="labelAddPackages" style="font-size: 16px; font-weight: 600; color: var(--text-dark); margin-bottom: 12px;">‡πÄ‡∏û‡∏¥‡πà‡∏° Package ‡πÉ‡∏´‡∏°‡πà:</h3>
                <div class="package-grid" id="newPackagesGrid"></div>

                <button class="btn btn-primary" onclick="savePackages()" id="btnSave" style="margin-top: 24px;">
                    <span>üíæ</span> <span id="btnSaveText">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
                </button>
            </div>
        </div>

        <!-- Success Section -->
        <div id="successSection" class="section">
            <div class="card" style="text-align: center;">
                <div class="success-icon">‚úÖ</div>
                <h2 id="successTitle" style="margin-bottom: 12px;">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h2>
                <p class="success-text" id="successMessage"></p>
                <button class="btn btn-secondary" onclick="liff.closeWindow()" id="btnClose">
                    <span id="btnCloseText">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // Configuration
        // ==========================================
        const LIFF_ID = '2008998734-1sLeZe9e';
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxdzTDNQLKyGeKVW3kPL8xr9lTykEsRpijJujMlLTD0XWLAsOwwZvnfqve8d2rf8ba-bQ/exec';

        // ==========================================
        // State
        // ==========================================
        let userId = '';
        let displayName = '';
        let currentLanguage = 'th';
        let customerData = null;
        let selectedPackages = [];

        // ==========================================
        // Package Data
        // ==========================================
        const packageData = {
            'wash_iron_50': { id: 'wash_iron_50', name_th: '‡∏ã‡∏±‡∏Å+‡∏£‡∏µ‡∏î 50 ‡∏ä‡∏¥‡πâ‡∏ô', name_en: 'Wash+Iron 50 pcs' },
            'wash_iron_100': { id: 'wash_iron_100', name_th: '‡∏ã‡∏±‡∏Å+‡∏£‡∏µ‡∏î 100 ‡∏ä‡∏¥‡πâ‡∏ô', name_en: 'Wash+Iron 100 pcs' },
            'iron_50': { id: 'iron_50', name_th: '‡∏£‡∏µ‡∏î 50 ‡∏ä‡∏¥‡πâ‡∏ô', name_en: 'Iron 50 pcs' },
            'iron_100': { id: 'iron_100', name_th: '‡∏£‡∏µ‡∏î 100 ‡∏ä‡∏¥‡πâ‡∏ô', name_en: 'Iron 100 pcs' },
            'wash_dry_50': { id: 'wash_dry_50', name_th: '‡∏ã‡∏±‡∏Å+‡∏≠‡∏ö 50 ‡∏ä‡∏¥‡πâ‡∏ô', name_en: 'Wash+Dry 50 pcs' },
            'wash_dry_100': { id: 'wash_dry_100', name_th: '‡∏ã‡∏±‡∏Å+‡∏≠‡∏ö 100 ‡∏ä‡∏¥‡πâ‡∏ô', name_en: 'Wash+Dry 100 pcs' }
        };

        // ==========================================
        // Language Translations
        // ==========================================
        const lang = {
            th: {
                loading: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...',
                regTitle: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô',
                regSubtitle: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì',
                labelRoomNumber: '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á',
                labelLocationName: '‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î/‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô',
                labelLocationType: '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó',
                labelPickupPoint: '‡∏à‡∏∏‡∏î‡∏£‡∏±‡∏ö-‡∏™‡πà‡∏á‡∏ú‡πâ‡∏≤',
                labelSelectPackages: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Package ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡πà‡∏≠‡∏¢ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)',
                btnRegister: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô',
                manageTitle: '‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Package',
                manageSubtitle: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Package ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ',
                labelCurrentPackages: 'Package ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:',
                labelAddPackages: '‡πÄ‡∏û‡∏¥‡πà‡∏° Package ‡πÉ‡∏´‡∏°‡πà:',
                btnSave: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                successTitle: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                successMessageReg: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡πÅ‡∏ä‡∏£‡πå‡πÇ‡∏•‡πÄ‡∏Ñ‡∏ä‡∏±‡πà‡∏ô‡πÉ‡∏ô LINE Chat',
                successMessagePackages: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Package ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
                btnClose: '‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á',
                fillAllFields: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô',
                selectAtLeastOne: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Package ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',
                locationType: {
                    condo: '‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î‡∏°‡∏¥‡πÄ‡∏ô‡∏µ‡∏¢‡∏°',
                    village: '‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô',
                    apartment: '‡∏≠‡∏û‡∏≤‡∏£‡πå‡∏ï‡πÄ‡∏°‡∏ô‡∏ï‡πå'
                }
            },
            en: {
                loading: 'Loading...',
                regTitle: 'Register',
                regSubtitle: 'Please fill in your information',
                labelRoomNumber: 'Room Number',
                labelLocationName: 'Condo/Village Name',
                labelLocationType: 'Type',
                labelPickupPoint: 'Pickup Point',
                labelSelectPackages: 'Select Frequently Used Packages (Multiple selection)',
                btnRegister: 'Register',
                manageTitle: 'Manage Packages',
                manageSubtitle: 'Select packages you want to use',
                labelCurrentPackages: 'Current Packages:',
                labelAddPackages: 'Add New Packages:',
                btnSave: 'Save',
                successTitle: 'Success!',
                successMessageReg: 'Registration successful!\nPlease close this window and share your location in LINE Chat',
                successMessagePackages: 'Packages saved successfully!',
                btnClose: 'Close Window',
                fillAllFields: 'Please fill in all fields',
                selectAtLeastOne: 'Please select at least 1 package',
                locationType: {
                    condo: 'Condominium',
                    village: 'Village',
                    apartment: 'Apartment'
                }
            }
        };

        // ==========================================
        // LIFF Initialization
        // ==========================================
        window.onload = async function() {
            try {
                await liff.init({ liffId: LIFF_ID });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                const profile = await liff.getProfile();
                userId = profile.userId;
                displayName = profile.displayName;

                // Check URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const mode = urlParams.get('mode');

                // Check if customer exists
                const customerCheck = await callAPI({
                    action: 'checkCustomer',
                    userId: userId
                });

                if (customerCheck.data.isNewCustomer) {
                    // New customer - show registration
                    showSection('registrationSection');
                    renderPackageGrid('packageGrid', []);
                } else {
                    customerData = customerCheck.data.customerData;
                    currentLanguage = customerData.language || 'th';
                    updateLanguageUI();
                    
                    if (mode === 'packages') {
                        // Manage packages mode
                        showManagePackages();
                    } else {
                        // Default: show registration for editing
                        showSection('registrationSection');
                        fillCustomerData();
                    }
                }
            } catch (error) {
                console.error('LIFF init error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        };

        // ==========================================
        // Language Functions
        // ==========================================
        function setLanguage(langCode) {
            currentLanguage = langCode;
            updateLanguageUI();
        }

        function updateLanguageUI() {
            // Update active button
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.lang-btn:nth-child(${currentLanguage === 'th' ? 1 : 2})`).classList.add('active');

            // Update all text
            const translations = lang[currentLanguage];
            
            document.getElementById('loadingText').textContent = translations.loading;
            document.getElementById('regTitle').textContent = translations.regTitle;
            document.getElementById('regSubtitle').textContent = translations.regSubtitle;
            document.getElementById('labelRoomNumber').textContent = translations.labelRoomNumber;
            document.getElementById('labelLocationName').textContent = translations.labelLocationName;
            document.getElementById('labelLocationType').textContent = translations.labelLocationType;
            document.getElementById('labelPickupPoint').textContent = translations.labelPickupPoint;
            document.getElementById('labelSelectPackages').textContent = translations.labelSelectPackages;
            document.getElementById('btnRegisterText').textContent = translations.btnRegister;
            document.getElementById('manageTitle').textContent = translations.manageTitle;
            document.getElementById('manageSubtitle').textContent = translations.manageSubtitle;
            document.getElementById('labelCurrentPackages').textContent = translations.labelCurrentPackages;
            document.getElementById('labelAddPackages').textContent = translations.labelAddPackages;
            document.getElementById('btnSaveText').textContent = translations.btnSave;
            document.getElementById('successTitle').textContent = translations.successTitle;
            document.getElementById('btnCloseText').textContent = translations.btnClose;

            // Update location type options
            const locationType = document.getElementById('locationType');
            locationType.options[0].text = translations.locationType.condo;
            locationType.options[1].text = translations.locationType.village;
            locationType.options[2].text = translations.locationType.apartment;

            // Re-render package grids if visible
            if (document.getElementById('packageGrid').children.length > 0) {
                renderPackageGrid('packageGrid', selectedPackages);
            }
            if (document.getElementById('currentPackagesGrid').children.length > 0) {
                const currentPkgs = customerData?.availablePackages?.split(',').filter(p => p.trim()) || [];
                renderManagePackagesUI(currentPkgs);
            }
        }

        // ==========================================
        // UI Functions
        // ==========================================
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
        }

        function renderPackageGrid(gridId, currentlySelected) {
            const grid = document.getElementById(gridId);
            grid.innerHTML = '';

            Object.values(packageData).forEach(pkg => {
                const isSelected = currentlySelected.includes(pkg.id);
                const pkgName = currentLanguage === 'th' ? pkg.name_th : pkg.name_en;

                const item = document.createElement('div');
                item.className = 'package-item' + (isSelected ? ' selected' : '');
                item.innerHTML = `
                    <input type="checkbox" id="${gridId}_${pkg.id}" ${isSelected ? 'checked' : ''}>
                    <label class="package-label" for="${gridId}_${pkg.id}">
                        <div class="package-checkbox"></div>
                        <span class="package-name">${pkgName}</span>
                    </label>
                `;

                item.addEventListener('click', function() {
                    const checkbox = item.querySelector('input');
                    checkbox.checked = !checkbox.checked;
                    item.classList.toggle('selected');
                    
                    if (checkbox.checked) {
                        if (!selectedPackages.includes(pkg.id)) {
                            selectedPackages.push(pkg.id);
                        }
                    } else {
                        selectedPackages = selectedPackages.filter(p => p !== pkg.id);
                    }
                });

                grid.appendChild(item);
            });

            selectedPackages = currentlySelected;
        }

        function fillCustomerData() {
            if (!customerData) return;

            document.getElementById('roomNumber').value = customerData.roomNumber || '';
            document.getElementById('locationName').value = customerData.locationName || '';
            document.getElementById('locationType').value = customerData.locationType || 'condo';
            document.getElementById('pickupPoint').value = customerData.pickupPoint || '';

            const packages = customerData.availablePackages ? customerData.availablePackages.split(',').filter(p => p.trim()) : [];
            renderPackageGrid('packageGrid', packages);
        }

        function showManagePackages() {
            const currentPkgs = customerData.availablePackages ? customerData.availablePackages.split(',').filter(p => p.trim()) : [];
            renderManagePackagesUI(currentPkgs);
            showSection('managePackagesSection');
        }

        function renderManagePackagesUI(currentPkgs) {
            const currentGrid = document.getElementById('currentPackagesGrid');
            const newGrid = document.getElementById('newPackagesGrid');
            
            currentGrid.innerHTML = '';
            newGrid.innerHTML = '';

            // Current packages (with delete button)
            if (currentPkgs.length > 0) {
                currentPkgs.forEach(pkgId => {
                    const pkg = packageData[pkgId];
                    if (!pkg) return;

                    const pkgName = currentLanguage === 'th' ? pkg.name_th : pkg.name_en;
                    const item = document.createElement('div');
                    item.className = 'package-item selected';
                    item.innerHTML = `
                        <label class="package-label">
                            <div class="package-checkbox"></div>
                            <span class="package-name">${pkgName}</span>
                            <button class="delete-btn" onclick="removePackage('${pkgId}')">√ó</button>
                        </label>
                    `;
                    currentGrid.appendChild(item);
                });

                document.getElementById('currentPackagesDiv').style.display = 'block';
            } else {
                document.getElementById('currentPackagesDiv').style.display = 'none';
            }

            // Available packages to add
            Object.values(packageData).forEach(pkg => {
                if (currentPkgs.includes(pkg.id)) return; // Skip already selected

                const pkgName = currentLanguage === 'th' ? pkg.name_th : pkg.name_en;
                const item = document.createElement('div');
                item.className = 'package-item';
                item.innerHTML = `
                    <input type="checkbox" id="new_${pkg.id}">
                    <label class="package-label" for="new_${pkg.id}">
                        <div class="package-checkbox"></div>
                        <span class="package-name">${pkgName}</span>
                    </label>
                `;

                item.addEventListener('click', function() {
                    const checkbox = item.querySelector('input');
                    checkbox.checked = !checkbox.checked;
                    item.classList.toggle('selected');
                });

                newGrid.appendChild(item);
            });

            selectedPackages = [...currentPkgs];
        }

        function removePackage(pkgId) {
            selectedPackages = selectedPackages.filter(p => p !== pkgId);
            renderManagePackagesUI(selectedPackages);
        }

        // ==========================================
        // API Functions
        // ==========================================
        async function callAPI(params) {
            const url = APPS_SCRIPT_URL + '?' + new URLSearchParams(params).toString();
            const response = await fetch(url);
            return await response.json();
        }

        // ==========================================
        // Registration
        // ==========================================
        async function registerCustomer() {
            const roomNumber = document.getElementById('roomNumber').value.trim();
            const locationName = document.getElementById('locationName').value.trim();
            const locationType = document.getElementById('locationType').value;
            const pickupPoint = document.getElementById('pickupPoint').value.trim();

            if (!roomNumber || !locationName || !pickupPoint) {
                alert(lang[currentLanguage].fillAllFields);
                return;
            }

            if (selectedPackages.length === 0) {
                alert(lang[currentLanguage].selectAtLeastOne);
                return;
            }

            try {
                showSection('loadingSection');

                const result = await callAPI({
                    action: 'registerCustomer',
                    userId: userId,
                    displayName: displayName,
                    roomNumber: roomNumber,
                    locationName: locationName,
                    locationType: locationType,
                    pickupPoint: pickupPoint,
                    language: currentLanguage,
                    packages: selectedPackages.join(',')
                });

                if (result.success) {
                    document.getElementById('successMessage').textContent = lang[currentLanguage].successMessageReg;
                    showSection('successSection');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
                showSection('registrationSection');
            }
        }

        // ==========================================
        // Save Packages
        // ==========================================
        async function savePackages() {
            // Get new packages from checkboxes
            const newPackages = [];
            document.querySelectorAll('#newPackagesGrid input[type="checkbox"]:checked').forEach(checkbox => {
                const pkgId = checkbox.id.replace('new_', '');
                newPackages.push(pkgId);
            });

            const allPackages = [...selectedPackages, ...newPackages];

            if (allPackages.length === 0) {
                alert(lang[currentLanguage].selectAtLeastOne);
                return;
            }

            try {
                showSection('loadingSection');

                const result = await callAPI({
                    action: 'updatePackages',
                    userId: userId,
                    packages: allPackages.join(',')
                });

                if (result.success) {
                    document.getElementById('successMessage').textContent = lang[currentLanguage].successMessagePackages;
                    showSection('successSection');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Save packages error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
                showManagePackages();
            }
        }
    </script>
</body>
</html>
